/*!CK:2058508100!*//*1400505533,178171423*/

if (self.CavalryLogger) { CavalryLogger.start_js(["0IRfT"]); }

__d("randomShuffle",["randomInt"],function(a,b,c,d,e,f,g){function h(i){for(var j=i.length-1;j>0;j--){var k=g.call(this,j+1);if(k!=j){var l=i[k];i[k]=i[j];i[j]=l;}}return i;}e.exports=h;});
__d("InteractionLogger",["Arbiter","Banzai","Event","copyProperties"],function(a,b,c,d,e,f,g,h,i,j){function k(l,m){m=m||{};this.profiler={};this.log={};this.lastInteraction=Date.now();this.interactionTime=0;this.eventSequence=[];this.projectName=l;if(m.trackInteractionTime)i.listen(document.body,'mousemove',this._pingActive.bind(this));if(m.submitOnLeave||m.submitOnLeave===undefined)this.arbiterToken=g.subscribe('onload/exit',function(){this.submit();this.arbiterToken.unsubscribe();}.bind(this));}j(k,{IDLE_LIMIT:20000});j(k.prototype,{set:function(l,m){this.log[l]=m;},tap:function(l){this.eventSequence.push(l);},bump:function(l,m){if(m===undefined)m=1;this.log[l]=(this.log[l]||0)+m;},bumpTap:function(l,m){this.tap(l);this.bump(l,m);},startRun:function(l){if(!this.profiler[l])this.profiler[l]={average:0,count:0};this.profiler[l].start=+new Date();},endRun:function(l){if(!this.profiler[l]||!this.profiler[l].start)return;this._recordRun(l,new Date()-this.profiler[l].start);this.profiler[l].start=null;},getLog:function(){this._updateLog();return this.log;},submit:function(){this._updateLog();h.post(this.projectName,this.log);},_pingActive:function(){var l=Date.now(),m=l-this.lastInteraction;if(m<(k.IDLE_LIMIT))this.interactionTime+=m;this.lastInteraction=l;},_updateLog:function(){for(var l in this.profiler){this.log[l+'-count']=this.profiler[l].count;this.log[l+'-average']=this.profiler[l].average;}if(this.interactionTime)this.log['interaction-time']=this.interactionTime;if(this.eventSequence.length)this.log['event-sequence']=this.eventSequence;},_recordRun:function(l,m){var n=this.profiler[l];n.average=(n.average*n.count+m)/(n.count+1);n.count++;}});e.exports=k;});
__d("MapPager",["ArbiterMixin","Event","mixin"],function(a,b,c,d,e,f,g,h,i){var j=i(g);for(var k in j)if(j.hasOwnProperty(k))m[k]=j[k];var l=j===null?null:j.prototype;m.prototype=Object.create(l);m.prototype.constructor=m;m.__superConstructor__=j;function m(n,o){"use strict";h.listen(n,'click',this.inform.bind(this,'previous'));h.listen(o,'click',this.inform.bind(this,'next'));}e.exports=m;});
__d("TimelineMapPlace",["arrayContains","copyProperties"],function(a,b,c,d,e,f,g,h){function i(j){this.stories=[];this.creation=false;this.name=null;j.latitude||(j.latitude=0);j.longitude||(j.longitude=0);h(this,j);if(this.region)this.region=this.region+':'+this.country;this.visibleStories=this.stories;}h(i.prototype,{setFilters:function(j){var k=[];for(var l=0;l<this.stories.length;l++)if(!j||g(this.stories[l].categories,j))k.push(this.stories[l]);this.visibleStories=k;},getStories:function(j,k){if(j===undefined)j=true;var l=j?this.visibleStories:this.stories;if(!k){return l;}else{var m=[];for(var n=0;n<l.length;n++){var o=l[n];if(k(o))m.push(o);}return m;}},count:function(j,k){var l=this.getStories(j,k).length;if(this.creation)l++;return l;}});h(i,{Filters:{MLE:function(j){return j&&!j.isEnt;},ALL:null}});e.exports=i;});
__d("TimelineMapStory",["copyProperties"],function(a,b,c,d,e,f,g){function h(i){g(this,i);}e.exports=h;});
__d("TimelineMapController",["AggregatedMap","shield","AggregatedMapCalloutOrientation","AggregatedMapPin","AggregatedMapRedPinSprite","Arbiter","AsyncRequest","BingMapCoordinate","CSS","DOM","MapRects","Rect","Style","TimelineMapPlace","TimelineMapStory","Vector","$","copyProperties","isEmpty","mod","randomShuffle"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa){var ba=198,ca=132,da=108;function ea(fa,ga,ha,ia,ja,ka,la){this.profileID=null;this.viewasID=null;this.places={};this.visiblePins=null;this.stories={};this.hiddenStories={};this.placesByTime=[];this.category=null;this.pending=null;this.waitingOnConfirmation=false;this.highlightedPin=null;this.arbiterListeners=[];this.calloutBeingFetched=null;this.initialized=false;this._lastResizeCalloutAnchor=null;this._lastResizeCalloutStoryHeight=null;this._lastResizeCalloutStory=null;this._scrollableCalloutController=null;this.inCreation=false;this.lastTypeaheadEvent=null;this.initialPosition=null;this.initialPlace=null;this.initialStory=null;this.hh=0;this.ww=0;this.smartPan=null;this.requestID=0;this.asyncRequests={};this.intervals=[];this.groups=[];this.pagerIndex=null;this.categoryCountUnique={};if(fa)this._init(fa,ga,ha,ia,ja,ka,la);}x(ea.prototype,{HOVER_FETCH_DELAY:100,HOVER_DISMISS_DELAY:300,MAP_BOTTOM_PADDING:40,MIN_MAP_HEIGHT:532,MIN_CALLOUT_STORY_HEIGHT:200,MAX_CALLOUT_HEIGHT:600,RESIZE_CHECK_INTERVAL:50,HOVERCARD_WIDTH:279,HOVERCARD_HEIGHT:251,HOVERCARD_CLOSED:undefined,HOVERCARD_WAITING_TO_FETCH:1,HOVERCARD_BEING_FETCHED:2,HOVERCARD_OPEN:3,HOVERCARD_WAITING_TO_DISMISS:4,TIMELINE_MAP_HOVERCARD_PLACE:'Place',TIMELINE_MAP_HOVERCARD_CITY:'City',TIMELINE_MAP_HOVERCARD_REGION:'Region',TIMELINE_MAP_HOVERCARD_COUNTRY:'Country',HOVERCARD_CITY_REGION_HEURISTIC:3,setCategory:function(fa){this.logger&&this.logger.startRun('set-category');this.map.hideCallout();this.category=fa;this._filter();},setCategoryCountUnique:function(fa){this.categoryCountUnique=fa;},getCategories:function(){var fa={},ga,ha;for(var ia in this.places){var ja=this.places[ia],ka={};for(var la=0;la<ja.stories.length;la++){ha=ja.stories[la];if(ha.categories)for(var ma=0;ma<ha.categories.length;ma++){ga=ha.categories[ma];if(!fa[ga])fa[ga]={count:0,name:ga};if(!ka[ga])ka[ga]=1;fa[ga].count++;}}}return fa;},zoomToVisible:function(){this.map.zoomTo(this.visiblePins);},cleanupCreationCallout:function(fa){this.map.hideCallout(fa);this._cleanUpHiglightedPin();},cancelCreation:function(fa){if(!this.inCreation)return;this.inCreation=false;this.cleanupCreationCallout();},creationFinished:function(fa,ga){var ha=ga.place,ia=ga.story,ja=ga.showCallout;this.inCreation=false;this.waitingOnConfirmation=false;this.cleanupCreationCallout();this.addStories(null,{stories:[ia],places:[ha]});if(ja)this.showCallout(null,{place_id:ha.id,story_id:ia.id});},page:function(fa){var ga=this.map.getGroups();if(!ga)return;var ha=[],ia=true,ja=0;for(var ka=0;ka<ga.length;ka++){var la=ga[ka];if(la.hasMarker()){var ma=la.getCenter(),na=new r(0,this.ww,this.hh,0);if(q.containsPoint(na,ma)){ha.push(la);if(la===this.groups[ja]){ja++;}else if(ia)ia=false;}}}ia=ia&&ja===this.groups.length;if(!ia){this.groups=ha;this.sortedGroups=ha.concat([]).sort(function(pa,qa){return pa.getCenter().x-qa.getCenter().x;});if(fa>0){this.pagerIndex=0;}else this.pagerIndex=-1;}else this.pagerIndex+=(fa>0)?1:-1;this.pagerIndex=z(this.pagerIndex,this.sortedGroups.length);var oa=this.sortedGroups[this.pagerIndex];if(oa.pins.length>1){this._openCallout(oa,this.map.throbber(325),this.map.leftRightNoPanningStrategy());oa.hoverPermanent=true;oa.hoverState=this.HOVERCARD_WAITING_TO_FETCH;this._fetchHovercard(oa);}else this.aggregatedMapHandler_pinClick(null,oa.pins[0]);},hovercard:function(fa,ga){var ha=this._getAsyncContext(ga.requestID);if(ha.deleted||ha.hoverState!==this.HOVERCARD_BEING_FETCHED)return;ha.hoverState=this.HOVERCARD_OPEN;var ia=p.create('div');ia.onmouseover=function(){if(!this.map||!this.map.getCallout().getAnchor())return null;this.aggregatedMapHandler_bubbleMouseover(null,this.map.getCallout().getAnchor());}.bind(this);ia.onmouseout=function(){if(!this.map||!this.map.getCallout().getAnchor())return null;this.aggregatedMapHandler_bubbleMouseout(null,this.map.getCallout().getAnchor());}.bind(this);o.setClass(ia,'fbTimelineMapHovercard');p.setContent(ia,ga.content);if(ha===this.map.getCallout().getAnchor()){this.map.getCallout().setContent(ia);}else this._openCallout(ha,ia,this.map.leftRightNoPanningStrategy());this.map.getCallout().recalculateArrowYOffset(true);this.logger&&this.logger.endRun('load-hovercard');},callout:function(fa,ga){var ha=this._getAsyncContext(ga.requestID);if(this.map.getCallout().getAnchor()!==ha)return;this._openCallout(ha,ga.content);this.logger&&this.logger.endRun('load-callout');},addPending:function(fa,ga){var ha=ga.count;this.pending=this.pending||0;this.pending+=ha;this._checkReady();},hideCallout:function(fa,ga){ga=ga||{};ga._instanceid=this.instanceID;l.inform('AggregatedMap/hideCallout',ga);},addStories:function(fa,ga){var ha=ga.stories,ia=ga.places;if(ga.count)this.pending=(this.pending||0)-ga.count;var ja,ka,la,ma;for(ma=0;ma<ia.length;ma++){ka=new t(ia[ma]);if(!this.places[ka.id]){this.places[ka.id]=ka;this.placesByTime.push(ka);}ka.mostRecentTimestamp=0;}for(ma=0;ma<ha.length;ma++){la=new u(ha[ma]);this.stories[la.id]=la;ja=la.placeID;ka=this.places[ja];ka.stories.push(la);ka.mostRecentTimestamp=Math.max(ka.mostRecentTimestamp,la.timestamp);}if(ga.count===undefined){this._refresh();}else this._checkReady();},updateStory:function(fa,ga){var ha=ga.place,ia=ga.story,ja=this.stories[ia.id];if(ja.placeID!=ha.id){var ka={};ka[ja.id]=true;this._removeStories(ja.placeID,ka);this.addStories(null,{stories:[ia],places:[ha]});}this._showCallout(this.places[ha.id].pin,ha.id,ia.id);},deleteStory:function(fa,ga){var ha=this.map.getCallout().getAnchor(),ia=this.stories[ga];if(!ia)return;var ja={};ja[ia.id]=true;this.map.hideCallout();var ka=this._removeStories(ia.placeID,ja);ka.stories_removed&&this._refresh();!ka.place_removed&&this._showCallout(ha,ha.place.id);},hideStory:function(fa,ga){var ha=this.map.getCallout().getAnchor(),ia=this.stories[ga.story_id];if(!ha)return;if(ha.getType()!=='AggregatedMapPin')return;if(!ia||ia.placeID!=ha.place.id)return;var ja=w(ga.story_domid);o.hide(ja);var ka=p.insertAfter(ja,ga.undo_html)[0];this.hiddenStories[ia.id]={story_domid:ja.id,undo_domid:ka.id};},undoHideStory:function(fa,ga){var ha=this.stories[ga],ia=this.hiddenStories[ha.id];p.remove(ia.undo_domid);o.show(ia.story_domid);delete this.hiddenStories[ha.id];},showCallout:function(fa,ga){var ha=this.places[ga.place_id].pin;this._showCallout(ha,ga.place_id,ga.story_id);},zoomIntoOne:function(fa,ga){var ha=this.places[ga.place_id];this._zoomToPlace(ha);},zoomToArea:function(fa,ga){var ha=ga.type,ia=ga.key,ja=[];for(var ka in this.places){var la=this.places[ka],ma=la.pin;if((la.city===ia&&ha===this.TIMELINE_MAP_HOVERCARD_CITY)||(la.region===ia&&ha===this.TIMELINE_MAP_HOVERCARD_REGION)||(la.country===ia&&ha===this.TIMELINE_MAP_HOVERCARD_COUNTRY))ja.push(ma);}this.map.zoomInto(ja);},creationFlow:function(fa,ga){var ha=ga.place,ia={latitude:ha.latitude,longitude:ha.longitude};this.waitingOnConfirmation=false;this._highlightPlace(ha.id,ia);this._openCallout(this.highlightedPin,ga.content,this.smartPan);this.inCreation=true;},highlightMapPlace:function(fa,ga){if(ga.dismiss&&this.waitingOnConfirmation)return;if(ga.showThrobber){this._openCallout(this.highlightedPin,this.map.throbber(),this.smartPan);return;}this.map.hideCallout();if(ga.dismiss){this._cleanUpHiglightedPin();}else if(ga.selected){this.waitingOnConfirmation=true;}else if(ga.center)this._highlightPlace(ga.placeID,ga.center);this.map.setView(ga);},registerScrollableCallout:function(fa,ga){this._scrollableCalloutController=ga;},_init:function(fa,ga,ha,ia,ja,ka,la){this.profileID=fa;this.viewasID=ga.viewas;this.mapContainer=ha;this.canvas=p.find(this.mapContainer,'.fbAggregatedMapContainer');this.logger=ja;this.instanceID=ia;this._dynamicSize=ga.dynamicSize;if(ga.center)this.initialPosition={latitude:ga.center.lat,longitude:ga.center.long};this.initialPlace=ga.highlightedPlace;this.initialStory=ga.highlightedStory;this.enableHovercards=ga.enableHovercards;this.calloutDiv=ka&&w(ka);la.subscribe('next',this.page.bind(this,1));la.subscribe('previous',this.page.bind(this,-1));this.border=w('fbTimelineMapBorder');this._subscribe('onload/exit',this._onBeforeLeave.bind(this));this._subscribe('AggregatedMap/ready',this._onInit.bind(this));this._subscribe('AggregatedMap/calloutHidden',this.cancelCreation.bind(this));this._subscribe('AggregatedMap/calloutHidden',h(l.inform,null,'reflow'));this._subscribe('TimelineMapStickyHeaderComposer/typeaheadFocus',this._handleTypeahead.bind(this,'focus'));this._subscribe('TimelineMapStickyHeaderComposer/typeaheadBlur',this._handleTypeahead.bind(this,'blur'));this._subscribe('TimelineMapStickyHeaderComposer/typeaheadSelect',this._handleTypeahead.bind(this,'select'));},_onInit:function(fa,ga){this.map=ga;if(this._dynamicSize){this._resizeMap();this.intervals=[setInterval(this._resizeMap.bind(this),this.RESIZE_CHECK_INTERVAL),setInterval(this.resizeCallout.bind(this),this.RESIZE_CHECK_INTERVAL)];}else{this.hh=this.map.getHeight();this.ww=this.map.getWidth();}this.initialized=true;for(var ha in ea.Listeners)this._subscribe('TimelineMap/'+ha,this[ha].bind(this));for(var ia in g.Events){var ja=this['aggregatedMapHandler_'+ia];if(ja){ja=ja.bind(this);this._subscribe('AggregatedMap/'+ia,ja);}}this.smartPan=this.map.smartPanningStrategy();},_getAsyncContext:function(fa){var ga=this.asyncRequests[fa];delete this.asyncRequests[fa];return ga;},_storeAsyncContext:function(fa){var ga=this.requestID++;this.asyncRequests[ga]=fa;return ga;},_inform:function(fa,ga,ha){ga=ga||{};ga._instanceid=this.instanceID;ea.inform('TimelineMap/'+fa,ga,ha);},_cleanUpHiglightedPin:function(){if(this.highlightedPin){if(this.highlightedPin.isPreview){this.map.removePin(this.highlightedPin);}else{this.highlightedPin.setSprite(this._getPlaceSprite(this.highlightedPin.place));this.map.redraw();}this.highlightedPin=null;o.removeClass(this.canvas,'fbTimelineMapDimPinMode');}},_handleTypeahead:function(fa){!this.inCreation&&fa=='blur'&&this.lastTypeaheadEvent=='focus';this.lastTypeaheadEvent=fa;},_checkReady:function(){if(this.pending!==0)return;this._refresh();if(this.logger){window._cstart&&this.logger.set('flushTTI',Date.now()-window._cstart);for(var fa in this.places){var ga=this.places[fa];this.logger.bump('places');this.logger.bump('stories',ga.count());}this.logger.set('profileID',this.profileID);}if(window.CavalryLogger)window.CavalryLogger.getInstance().measurePageLoad(true);var ha=this.initialPlace,ia=this.initialStory;if(ha){this.map.zoomTo(this.visiblePins,false);this.map.setInitialView();var ja=this.places[ha].pin;if(ja){var ka=new v(ba,ca);ka=ka.sub(new v(this.ww/2,this.hh/2));this.map.zoomIntoOne(ja,ka);var la=p.find(this.calloutDiv,'.fbTimelineMapCallout');p.remove(this.calloutDiv);this._openCallout(ja,la);this.map.getCallout().setArrowYOffset(da);this.map.updateCallouts();}}else if(this.initialPosition){this.map.setView({center:this.initialPosition});}else{this.map.zoomTo(this.visiblePins,false);this.map.setInitialView();}o.addClass(this.border,'fbTimelineMapContainerLoaded');},_refresh:function(){this.placesByTime=this.placesByTime.sort(function(fa,ga){return fa.mostRecentTimestamp-ga.mostRecentTimestamp;});this._filter();this._inform(ea.Events.updateCategories,null,l.BEHAVIOR_STATE);},_resizeMap:function(){var fa=v.getViewportDimensions().y,ga=v.getElementPosition(this.border).y,ha=v.getElementDimensions(this.border).y,ia=fa-(ga+ha),ja=this.hh+ia-this.MAP_BOTTOM_PADDING;ja=Math.max(this.MIN_MAP_HEIGHT,Math.min(ja,fa));if(Math.abs(this.hh-ja)>1){s.set(this.mapContainer,'height',ja+'px');this.hh=ja;this.ww=this.map.ww;this._resizeMap();}},resizeCallout:function(){var fa=this.map.getCallout().getContent(),ga=p.scry(fa,'.fbTimelineMapScrollableStory');for(var ha=ga.length-1;ha>=0;ha--)if(!o.hasClass(ga[ha],'hidden_elem')){var ia=ga[ha],ja=p.find(ia,'.fbTimelineMapCalloutStory');break;}if(!(fa&&ja&&ia))return;var ka=v.getElementDimensions(ja).y;if(this.map.getCallout().getAnchor()===this._lastResizeCalloutAnchor&&ka===this._lastResizeCalloutStoryHeight&&ja===this._lastResizeCalloutStory)return;var la=p.find(fa,'.fbTimelineMapCalloutHeader'),ma=v.getElementDimensions(la).y,na=v.getElementPosition(ia).y,oa=v.getElementPosition(this.mapContainer).y,pa=this.hh-this.map.CALLOUT_MARGIN,qa=Math.max(this.MIN_CALLOUT_STORY_HEIGHT,Math.min((oa+pa)-na,pa-ma)),ra=Math.min(ka,qa,this.MAX_CALLOUT_HEIGHT);s.set(ia,'height',ra+'px');this._lastResizeCalloutAnchor=this.map.getCallout().getAnchor();this._lastResizeCalloutStoryHeight=ka;this._lastResizeCalloutStory=ja;if(this._scrollableCalloutController)this._scrollableCalloutController.adjustGripper();this.map.getCallout()._updateDimensions();this.map.getCallout().recalculateArrowYOffset();},_filter:function(){var fa=[];for(var ga in this.places){var ha=this.places[ga];ha.setFilters(this.category);if(ha.count()>0){var ia=this._getPlaceSprite(ha),ja=j.create(ha,ia,ha.name);ha.pin=ja;ja.place=ha;fa.push(ja);}}this.visiblePins=fa;if(this.highlightedPin)this.visiblePins.push(this.highlightedPin);this.map.setPins(fa);},_getPlaceSprite:function(fa){var ga=fa.getStories(),ha=ga.length,ia;if(ha>=100){ia=k.largeBlank(ha);}else if(ha>10){ia=k.mediumBlank(ha);}else if(ha>1){ia=k.smallBlank(ha);}else if(ga[0]&&ga[0].pin){ia=k.mediumBlank(1);ia.text=false;ia.image=ga[0].pin+'.png';}else ia=k.dot();return ia;},_getHighlightedSprite:function(){var fa=k.dot();fa.aggregationRadius=0;fa.css='fbTimelineMapHighlighted';return fa;},_highlightPlace:function(fa,ga){this._cleanUpHiglightedPin();var ha;if(fa&&this.places[fa]!==undefined){ha=this.places[fa].pin;ha.setSprite(this._getHighlightedSprite());this.map.redraw();}else{ha=new j(n.fromLatLong(ga),this._getHighlightedSprite());ha.isPreview=true;this.map.addPin(ha);}this.highlightedPin=ha;o.addClass(this.canvas,'fbTimelineMapDimPinMode');return ha;},_showCallout:function(fa,ga,ha){this._openCallout(fa,this.map.throbber(),this.smartPan);this._fetchCallout(fa,ga,ha);},_fetchCallout:function(fa,ga,ha){this.logger&&this.logger.startRun('load-callout');var ia=this._storeAsyncContext(fa),ja=this.places[ga],ka=[],la={},ma=ja.getStories();for(var na=0;na<ma.length;++na){var oa=ma[na];if(!oa.isEnt){ka.push(oa.unitParams);}else{la[oa.storyType]=la[oa.storyType]||[];la[oa.storyType].push(oa.id);}}var pa={profile_id:this.profileID,targetid:ja.id,storyid:ha,unitparams:ka,storiesbytype:la,request_id:ia};if(this.viewasID&&this.viewasID!="0")pa.viewas=this.viewasID;new m().setURI('/ajax/timeline/map/callout.php').setMethod('POST').setData(pa).send();},_openCallout:function(fa,ga,ha){var ia=this.map.getCallout().getAnchor();ia&&this._dismissHovercard(ia);this.map.openCallout(fa,ga,ha);this.resizeCallout();},_zoomToPlace:function(fa){var ga=i.LEFT,ha=i.RIGHT,ia=this.map.getCallout().getOrientation()===ga,ja=new v(ia?200:-200,0);this.map.zoomIntoOne(fa.pin,ja);this._openCallout(fa.pin,this.map.throbber(),this.map.noPanningStrategy(ia?ga:ha));this._fetchCallout(fa.pin,fa.id);},_fetchHovercard:function(fa){this.logger&&this.logger.startRun('load-hovercard');if(fa.deleted||fa.hoverState!==this.HOVERCARD_WAITING_TO_FETCH)return;if(fa.pins.length<2)throw 'bubble has < 2 pins!';delete fa.timeoutToken;fa.hoverState=this.HOVERCARD_BEING_FETCHED;var ga=[],ha=[],ia={},ja={},ka={},la={},ma={},na={};fa.pins.forEach(function(kb){var lb=kb.place,mb=lb.getStories();na[lb.id]=true;for(var nb=0;nb<mb.length;nb++)ga.push(mb[nb]);ha.push(lb);if(lb.city){ia[lb.city]=ia[lb.city]||0;ia[lb.city]++;if(lb.region)ma[lb.region]=lb.city;if(lb.country)la[lb.country]=lb.city;}if(lb.region){ja[lb.region]=ja[lb.region]||0;ja[lb.region]++;}if(lb.country){ka[lb.country]=ka[lb.country]||0;ka[lb.country]++;}});var oa=ha.length,pa=this._storeAsyncContext(fa),qa=this._getStoriesByType(ga).TimelineMapStoryPhoto||[],ra=qa.length,sa=aa(qa).slice(0,4),ta={},ua=ha.length<=3,va=ha.sort(function(kb,lb){return lb.getStories().length-kb.getStories().length;}).slice(0,3).map(function(kb){var lb=0,mb={},nb=kb.getStories();for(var ob=0;ob<nb.length;ob++){var pb=nb[ob],qb=pb.visitID;if(qb===0){lb++;}else if(!(qb in mb)){mb[qb]=true;lb++;}}ta[kb.id]=lb;return kb.id;}),wa=false,xa=false,ya=false;for(var za in this.places){var ab=this.places[za];if(!na[ab.id]&&(ya=ya||ka[ab.country])&&(xa=xa||ja[ab.region])&&(wa=wa||ia[ab.city]))break;}var bb=null,cb=null,db=null,eb=null,fb=null,gb=function(kb,lb,mb){return kb[mb]-kb[lb];};ia=Object.keys(ia).sort(gb.bind(null,ia));ja=Object.keys(ja).sort(gb.bind(null,ja));ka=Object.keys(ka).sort(gb.bind(null,ka));var hb={};hb[this.TIMELINE_MAP_HOVERCARD_COUNTRY]=ka.map(function(kb){return la[kb];});hb[this.TIMELINE_MAP_HOVERCARD_REGION]=ja.map(function(kb){return ma[kb];});hb[this.TIMELINE_MAP_HOVERCARD_CITY]=ia;hb[this.TIMELINE_MAP_HOVERCARD_PLACE]=ha.map(function(kb){return kb.id;});if(ka.length>0)if(!ya){cb=this.TIMELINE_MAP_HOVERCARD_COUNTRY;if(ka.length>1){eb=this.TIMELINE_MAP_HOVERCARD_COUNTRY;}else if(ja.length>1){eb=this.TIMELINE_MAP_HOVERCARD_REGION;}else eb=this.TIMELINE_MAP_HOVERCARD_CITY;}if(ja.length>0&&!cb){var ib=this.HOVERCARD_CITY_REGION_HEURISTIC;if(!xa||ja.length>1&&ia.length>ja.length*ib){cb=this.TIMELINE_MAP_HOVERCARD_REGION;if(ja.length>1){eb=this.TIMELINE_MAP_HOVERCARD_REGION;}else eb=this.TIMELINE_MAP_HOVERCARD_CITY;}}if(ia.length>0&&!cb)if(!wa||ia.length>1){cb=this.TIMELINE_MAP_HOVERCARD_CITY;if(ia.length>1){eb=this.TIMELINE_MAP_HOVERCARD_CITY;}else fb=ha.length;}if(!cb){cb=this.TIMELINE_MAP_HOVERCARD_PLACE;fb=-1;}bb=hb[cb];if(eb)db=hb[eb];var jb={profile_id:this.profileID,request_id:pa,target_count:oa,photo_count:ra,photo_ids:sa,place_counts:ta,target_ids:va,all_places:ua,ids:bb,title_type:cb,subtitle_count:fb,links:db,link_type:eb};if(this.viewasID&&this.viewasID!="0")jb.viewas=this.viewasID;new m().setURI('/ajax/timeline/map/hovercard.php').setMethod('POST').setData(jb).send();},_dismissHovercard:function(fa){delete fa.timeoutToken;delete fa.hoverState;delete fa.hoverPermanent;if(this.map.getCallout().getAnchor()===fa)this.map.hideCallout();},_getStoriesByType:function(fa){var ga={};fa.forEach(function(ha){ga[ha.storyType]=ga[ha.storyType]||[];ga[ha.storyType].push(ha.isEnt?ha.id:ha.unitParams);});return ga;},_removeStories:function(fa,ga){var ha=0,ia=false,ja=this.places[fa],ka=[],la;for(la=0;la<ja.stories.length;++la){var ma=ja.stories[la];if(ga[ma.id]){delete this.stories[ma.id];++ha;}else ka.push(ma);}if(ka.length===0){delete this.places[fa];ia=true;}else ja.stories=ka;return {place_removed:ia,stories_removed:ha};},_removeHiddenStories:function(){var fa=this.map.getCallout().getAnchor();if(!fa)return;if(fa.getType()!=='AggregatedMapPin')return;if(y(this.hiddenStories))return;var ga=fa.place.id,ha=this._removeStories(ga,this.hiddenStories);if(ha.stories_removed!==0){this._refresh();this.hiddenStories={};}},_guard:function(fa){return function(ga,ha){if(!ha||!ha._instanceid||ha._instanceid===this.instanceID)fa(ga,ha);}.bind(this);},_subscribe:function(fa,ga){this.arbiterListeners.push(l.subscribe(fa,this._guard(ga)));},aggregatedMapHandler_mapClick:function(){this._removeHiddenStories();this.map.hideCallout();this._inform(ea.Events.mapClick);},aggregatedMapHandler_pinClick:function(fa,ga){this.logger&&this.logger.bumpTap('pin-click');this._removeHiddenStories();if(this.map.getCallout().getAnchor()===ga){this.map.hideCallout();}else this._showCallout(ga,ga.place.id);},aggregatedMapHandler_bubbleClick:function(fa,ga){this.logger&&this.logger.bumpTap('bubble-click');this.map.hideCallout();this.map.zoomInto(ga.pins);},aggregatedMapHandler_bubbleMouseover:function(fa,ga){if(!this.enableHovercards||ga.hoverPermanent)return;if(!ga.hoverState||ga.hoverState===this.HOVERCARD_CLOSED){ga.hoverState=this.HOVERCARD_WAITING_TO_FETCH;ga.timeoutToken=setTimeout(this._fetchHovercard.bind(this,ga),this.HOVER_FETCH_DELAY);}else if(ga.hoverState===this.HOVERCARD_WAITING_TO_DISMISS){clearTimeout(ga.timeoutToken);delete ga.timeoutToken;ga.hoverState=this.HOVERCARD_OPEN;}},aggregatedMapHandler_bubbleMouseout:function(fa,ga){if(ga.hoverPermanent)return;if(ga.hoverState===this.HOVERCARD_WAITING_TO_FETCH||ga.hoverState===this.HOVERCARD_BEING_FETCHED){clearTimeout(ga.timeoutToken);delete ga.timeoutToken;delete ga.hoverState;}else if(ga.hoverState===this.HOVERCARD_OPEN){ga.timeoutToken=setTimeout(this._dismissHovercard.bind(this,ga),this.HOVER_DISMISS_DELAY);ga.hoverState=this.HOVERCARD_WAITING_TO_DISMISS;}},_onBeforeLeave:function(){for(var fa=0;fa<this.arbiterListeners.length;fa++)this.arbiterListeners[fa].unsubscribe();for(var ga=0;ga<this.intervals.length;ga++)clearInterval(this.intervals[ga]);this.logger=null;this.map=null;this.places=null;}});x(ea,{Events:{updateCategories:'updateCategories',mapClick:'mapClick'},Listeners:{addStories:'addStories',updateStory:'updateStory',deleteStory:'deleteStory',hideStory:'hideStory',undoHideStory:'undoHideStory',addPending:'addPending',creationFlow:'creationFlow',cleanupCreationCallout:'cleanupCreationCallout',cancelCreation:'cancelCreation',creationFinished:'creationFinished',showCallout:'showCallout',callout:'callout',resizeCallout:'resizeCallout',hovercard:'hovercard',highlightMapPlace:'highlightMapPlace',registerScrollableCallout:'registerScrollableCallout',zoomToVisible:'zoomToVisible',hideCallout:'hideCallout',zoomIntoOne:'zoomIntoOne',zoomToArea:'zoomToArea'},inform:function(fa,ga,ha){if(!ga||!ga._instanceid)return;return l.inform(fa,ga,ha||l.BEHAVIOR_PERSISTENT);}});e.exports=ea;});
__d("TimelineMapFilter",["Arbiter","CSS","DOM","Event","NumberFormatConfig","PageTransitions","StickyPlaceholderInput","tidyEvent","TimelineDynamicSectionConfig","ads-lib-formatters","copyProperties","cx","ge","$"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){var u='pagelet_timeline_medley_map',v='map';function w(y){var z=y.getQueryData().sk||y.getPath().split('/')[2];return (o.skmapping[z]||z)===v;}function x(){}q(x.prototype,{init:function(y,z,aa,ba,ca){this._classes={count:"_3d0",filter:"_3c_",selected:"_3s-",text:"_3sz"};this.catNames=[];this.catIndex=0;this.categoryButtons=[];this.mapController=y;this.stickies=z||[];this.tagUnit=s('fbTimelineMapTagUnit');this.tagUnitInited=false;this.mapID=aa;this.pluralMap=ba;this.initialCatName=ca;var da={},ea,fa;for(ea=0;ea<this.stickies.length;ea++){fa=this.stickies[ea].name[2];da[fa]=this.stickies[ea].countOnlyUnique;this.categoryButtons[ea]=this.stickies[ea].buttonID&&s(this.stickies[ea].buttonID);if(this.categoryButtons[ea])j.listen(this.categoryButtons[ea],'click',this.handleTabClick.bind(this,ea));}this.mapController.setCategoryCountUnique(da);n([g.subscribe('TimelineMap/updateCategories',this.updateCategories.bind(this))]);},setCategory:function(y){this.mapController.setCategory(this.catNames[y]);var z=t(u),aa=i.scry(z,'.fbTimelineStickyHeaderPlaceComposer input.skiptowant')[0];if(aa)aa.setAttribute('value',this.stickies[y].name.skip_to_want);var ba=i.scry(z,'.fbTimelineStickyHeaderPlaceComposer div.uiStickyPlaceholderInput')[0];if(ba)m.setPlaceholderText(ba,this.stickies[y].name.placeholder);var ca=i.scry(z,'div.'+"_4_zv")[0];if(ca)i.setContent(ca,this.stickies[y].name.section_title);},handleTabClick:function(y,z){var aa=l.getCurrentURI().getUnqualifiedURI();z&&!z.isDefaultRequested()&&z.prevent();if(w(aa)&&this.stickies[y].uri)l.rewriteCurrentURI(aa,this.stickies[y].uri);this.setCategory(y);this.mapController.zoomToVisible();},setFilter:function(y,z,aa,ba,ca){var da=this.categoryButtons[y];if(!da)return;var ea=aa||0;if(ea>=200)ea=(ea%100)+100;ea=z[this.pluralMap[ea]];this.catNames[y]=z[2];i.setContent(i.find(da,'.'+this._classes.text),ea);if(aa){i.setContent(i.find(da,'.'+this._classes.count),p.formatNumber(aa,0,k.numberDelimiter,''));}else i.empty(i.find(da,'.'+this._classes.count));h.conditionClass(da.firstChild,ba,!!ba);if(ca)da.setAttribute('href',ca);h.show(da);},updateCategories:function(y,z){if(z._instanceid!==this.mapID)return;var aa=this.mapController.getCategories(),ba=this.catNames[this.catIndex]||this.initialCatName;this.catNames=[];var ca=0;for(var da=0;da<this.stickies.length;da++){var ea=this.stickies[da],fa=ea.name,ga=0,ha=ea.domClass,ia=fa[2];if(aa[ia]){ga=aa[ia].count;delete aa[ia];}if(ea.showWhenZero||ga!==0){this.setFilter(ca,fa,ga,ha,ea.uri);ca++;}}var ja=[];for(var ka in aa)ja.push(aa[ka]);ja=ja.sort(function(oa,pa){return pa.count-oa.count;});for(var la=0;la<this.categoryButtons.length-ca;la++){var ma=ja[la];if(ma){this.setFilter(la+ca,ma.name,ma.count);}else h.hide(this.filters[la+ca]);}if(ba){this.initialCatName=null;var na=this.catNames.indexOf(ba);if(na!=-1){this.setCategory(na);}else this.setCategory(0);}}});q(x,{init:function(){var y=new x();y.init.apply(y,arguments);}});e.exports=x;});
__d("TimelineMapStickyHeaderComposer",["Arbiter","AsyncRequest","Bootloader","CSS","$","bind","copyProperties","ge"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(){g.subscribe('TimelineMapStickyHeaderComposer/showPhotoTagUnit',this.showPhotoTagUnit.bind(this));g.subscribe('TimelineMapStickyHeaderComposer/hidePhotoTagUnit',this.hidePhotoTagUnit.bind(this));}m(o.prototype,{initPlaceTypeahead:function(p){p.subscribe('focus',function(){i.loadModules(["TimelineMLE"],function(q){q.hideFlyout();});g.inform('TimelineMapStickyHeaderComposer/typeaheadFocus');}.bind(this));p.subscribe('blur',function(){g.inform('TimelineMapStickyHeaderComposer/typeaheadBlur');}.bind(this));p.subscribe('select',function(){g.inform('TimelineMapStickyHeaderComposer/typeaheadSelect');}.bind(this));},showPhotoTagUnit:function(p,q){this.tagUnit=k('fbTimelineMapTagUnit');j.show(this.tagUnit);var r=n('mainContainer');r&&j.addClass(r,'photoTaggingMode');if(!this.tagUnitInited){this.tagUnitInited=true;this.indicator=k('fbTimelineMapAddPhotoLoading');j.show(this.indicator);var s=q?q.sid:null;new h().setURI('/ajax/timeline/map/photo_strip.php').setData({div_id:'fbTimelineMapTagUnit',sid:s}).setReadOnly(true).setHandler(l(this,'_onLoadPhotoStrip')).send();}else this._onLoadPhotoStrip();},hidePhotoTagUnit:function(){this.tagUnit=k('fbTimelineMapTagUnit');j.hide(this.tagUnit);var p=n('mainContainer');p&&j.removeClass(p,'photoTaggingMode');},_onLoadPhotoStrip:function(){j.hide(this.indicator);}});e.exports=o;});
__d("legacy:TimelineMapStickyHeaderComposer",["TimelineMapStickyHeaderComposer"],function(a,b,c,d){a.TimelineMapStickyHeaderComposer=b('TimelineMapStickyHeaderComposer');},3);
__d("TypeaheadTimelineHighlightMapPlace",["Arbiter","copyProperties"],function(a,b,c,d,e,f,g,h){function i(j){this._typeahead=j;}h(i.prototype,{_subscription:null,enable:function(){this._subscription=this._typeahead.subscribe(['reset','select','highlight'],function(j,k){if(j==='highlight'&&k.index!==-1&&k.selected.type!='freeform'&&k.selected.latitude&&k.selected.longitude&&!k.selected.changeCity&&k.index!=this.lastDataIdx){var l=k.selected.place_type=='city'?10:15;g.inform('TimelineMap/highlightMapPlace',{placeID:k.selected.uid,center:{latitude:k.selected.latitude,longitude:k.selected.longitude},zoom:l});}else if(j==='highlight'&&k.index==-1){g.inform('TimelineMap/highlightMapPlace',{dismiss:true});}else if(j==='select'){g.inform('TimelineMap/highlightMapPlace',{selected:true});}else if(j==='reset')g.inform('TimelineMap/highlightMapPlace',{dismiss:true});this.lastDataIdx=k&&k.index;});},disable:function(){this._typeahead.unsubscribe(this._subscription);this._subscription=null;}});e.exports=i;});
__d("TypeaheadTimelineShowThrobberOnSelect",["Arbiter","copyProperties"],function(a,b,c,d,e,f,g,h){function i(j){this._typeahead=j;}h(i.prototype,{_subscription:null,enable:function(){this._subscription=this._typeahead.subscribe(['select'],function(j,k){g.inform('TimelineMap/highlightMapPlace',{showThrobber:true});});},disable:function(){this._typeahead.unsubscribe(this._subscription);this._subscription=null;}});e.exports=i;});
__d("legacy:TimelineMapPlaceTypeaheadBehaviors",["TypeaheadTimelineHighlightMapPlace","TypeaheadTimelineShowThrobberOnSelect"],function(a,b,c,d,e,f,g,h){if(!a.TypeaheadBehaviors)a.TypeaheadBehaviors={};a.TypeaheadBehaviors.highlightMapPlace=function(i){i.enableBehavior(g);};a.TypeaheadBehaviors.showThrobberOnSelect=function(i){i.enableBehavior(h);};},3);
__d("RelationshipStatusConst",["fbt"],function(a,b,c,d,e,f,g){e.exports={UNDEFINED:0,SINGLE:1,IN_A_RELATIONSHIP:2,OPEN_RELATIONSHIP:3,MARRIED:4,ENGAGED:5,COMPLICATED:6,WIDOWED:7,SEPARATED:8,DIVORCED:9,CIVIL_UNION:10,DOMESTIC_PATNERSHIP:11,isUnilateralStatus:function(h){return (h==this.UNDEFINED||h==this.SINGLE||h==this.WIDOWED||h==this.SEPARATED||h==this.DIVORCED);},getAnniversaryText:function(h){switch(h){case this.IN_A_RELATIONSHIP:case this.OPEN_RELATIONSHIP:case this.MARRIED:case this.CIVIL_UNION:case this.DOMESTIC_PARTNERSHIP:return ("Anniversary");case this.ENGAGED:case this.COMPLICATED:return ("Since");default:throw new Error('Relationship status doesn\'t support anniversaries');}},willCreateLifeEvent:function(h,i,j,k){if(this.isUnilateralStatus(i))return false;if(i==this.COMPLICATED&&!this.isUnilateralStatus(h))return false;if(i!=h)return true;if(j>0&&k>0&&j!=k)return true;return false;}};});
__d("TimelineInfoReviewRelationshipForm.react",["ReactPropTypes","React","RelationshipStatusConst","TimelineChecklist.react","TimelineSingleTypeahead.react","TimelineTypeaheadContainer.react","createObjectFrom","cx","invariant"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){var p=h.createClass({displayName:'TimelineInfoReviewRelationshipForm',propTypes:{excludedEntries:g.array.isRequired,options:g.array.isRequired,placeholder:g.string.isRequired,relationName:g.string.isRequired,relationshipName:g.string.isRequired,searchSource:g.object.isRequired,selectedRelationship:g.number},getDefaultProps:function(){return {selectedRelationship:null};},getInitialState:function(){return {selectedRelationship:this.props.selectedRelationship};},render:function(){var q=this.state.selectedRelationship,r=null;if(q&&!i.isUnilateralStatus(q))r=l(null,k({excludedEntries:m(this.props.excludedEntries,true),placeholder:this.props.placeholder,requireSelection:true,searchSource:this.props.searchSource,selectedEntry:this.props.selectedEntry,selectionName:this.props.relationName}));return (h.DOM.div(null,j({baseName:this.props.relationshipName,className:"_5us2",onChange:this._checklistChangeHandler,options:this.props.options,overflow:"scroll",ref:"checklist"}),r));},_checklistChangeHandler:function(){var q=Object.keys(this.refs.checklist.getSelection());o(q.length<=1);this.state.selectedRelationship=q.length===1?parseInt(q[0],10):null;this.forceUpdate();}});e.exports=p;});
__d("TimelineLifeEventPhotoPreviewGrid",["AsyncUploadRequest","AsyncRequest","Bootloader","CSS","DOM","FileInputUploader","Parent","ProgressBar","SortableGroup","TimelineLifeEventPhotoConfig","tx","Button","csx"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){var t=1,u=2,v=3,w=[null,'mleOnePhoto','mleTwoPhotos','mleManyPhotos'];function x(ba,ca,da,ea){"use strict";this._container=ba;this._containerID=ba.id;this._grid=ca;this._photoLimit=da;this._profileID=ea;this._progressBarMarkup=p.progressBarMarkup;this._loadingIndicators=[];this._pendingPhotoRequests=0;this._photoDisplayType=0;this._tempPhotoRef=[];this._saveButton=k.find(this._container,"._5mlk");if(!p.enableDrag)return;this._sortableGroup=new o().setGrabCallback(z).setDropCallback(aa);var fa=k.scry(ca,'.mlePhotoPreviewThumb');for(var ga=0;ga<fa.length;ga++)this._bindPhoto(fa[ga]);this._updatePhotoDisplayType(fa.length);}x.prototype.destroy=function(){"use strict";this._sortableGroup&&this._sortableGroup.destroy();};x.prototype._getNumPhotos=function(){"use strict";return k.scry(this._grid,'.mlePhotoPreviewThumb').length+k.scry(this._grid,'.mlePhotoPlaceholder').length;};x.prototype._getPhotoType=function(ba){"use strict";switch(ba){case 0:case 1:return t;case 2:return u;default:if((ba<0)||(ba>this._photoLimit))throw new Error('invalid number of photos');return v;}};x.prototype._updatePhotoDisplayType=function(ba){"use strict";var ca=w[this._photoDisplayType];ca&&j.removeClass(this._container,ca);this._photoDisplayType=this._getPhotoType(ba);j.addClass(this._container,w[this._photoDisplayType]);};x.prototype._updateAddMorePhotosClass=function(){"use strict";if(this._pendingPhotoRequests>0){j.addClass(k.find(this._container,'.mleAddMorePhotoButtons'),'disabled');}else j.removeClass(k.find(this._container,'.mleAddMorePhotoButtons'),'disabled');};x.prototype._updatePhotos=function(ba,ca){"use strict";var da=ca,ea=[],fa=this._photoDisplayType;this._updatePhotoDisplayType(ba);if(this._photoDisplayType!==fa){var ga=k.scry(this._grid,'.mlePhotoPreviewThumb');for(var ha=0;ha<ga.length;ha++){var ia=k.find(ga[ha],'.mlePhotoPreviewInput').value;ea.push(ia);if((this._photoDisplayType===v)||(fa===v)){this._unbindPhoto(ga[ha]);k.remove(ga[ha]);this.createPlaceholder(ia);}else{j.addClass(ga[ha],'photoLoading');j.hide(k.find(ga[ha],'.detachPhotoIcon'));j.show(k.find(ga[ha],'.photoLoadingSpinner'));this._unbindPhoto(ga[ha]);this._tempPhotoRef[ia]=ga[ha];}}}var ja=da.concat(ea);if(ja.length>0){this._pendingPhotoRequests+=ja.length;if(this._photoDisplayType!==v)this._updateAddMorePhotosClass();new h().setURI('/ajax/timeline/mle_photo_select.php').setData({display_elem:this._containerID,existing_image_ids:ea,field_name:'photos',image_ids:da,profile_id:this._profileID,total_photos:ba}).setMethod('POST').send();}};x.prototype._bindPhoto=function(ba){"use strict";this._sortableGroup&&this._sortableGroup.addSortable(k.find(ba,'input').getAttribute('value'),ba);};x.prototype._unbindPhoto=function(ba){"use strict";this._sortableGroup&&this._sortableGroup.removeSortable(k.find(ba,'input').getAttribute('value'));};x.prototype.filterPhotoClick=function(event){"use strict";if((this._pendingPhotoRequests>0)&&(this._photoDisplayType!=v))event.kill();};x.prototype.attachPhoto=function(ba,ca){"use strict";if((!this._loadingIndicators[ca])&&(!this._tempPhotoRef[ca]))return;if(this._tempPhotoRef[ca]){k.replace(this._tempPhotoRef[ca],ba);this._bindPhoto(ba);delete this._tempPhotoRef[ca];}else{var da=this._loadingIndicators[ca].getRoot();if(m.byTag(da,'body')){k.replace(da,ba);this._bindPhoto(ba);}delete this._loadingIndicators[ca];}if(--this._pendingPhotoRequests===0)this._updateAddMorePhotosClass();};x.prototype.detachPhoto=function(ba){"use strict";if(this._pendingPhotoRequests>0)return;this._unbindPhoto(ba);k.remove(ba);var ca=this._getNumPhotos();this._updatePhotos(ca,[]);if(ca===0){j.show(k.find(this._container,'.mlePhotoButtons'));j.hide(k.find(this._container,'.mleAddMorePhotoButtons'));}else if(ca===this._photoLimit-1)j.show(k.find(this._container,'.mleAddMorePhotoButtons'));};x.prototype.createPlaceholder=function(ba){"use strict";var ca=this._progressBarMarkup.cloneNode(true);ca=k.appendContent(this._grid,ca)[0];this._loadingIndicators[ba]=new n(ca);return ca;};x.prototype.addPhotos=function(ba){"use strict";var ca=this._getNumPhotos(),da=ba.length,ea=ca+da;if(ea>this._photoLimit){var fa=q._("The maximum number of photos you can add to this life event is {limit}. Please remove some photos and try again.",{limit:this._photoLimit});i.loadModules(["Dialog"],function(ia){new ia().setTitle("Too Many Photos").setBody(fa).setButtons(ia.OK).show();});return;}if(ea===this._photoLimit)j.hide(k.find(this._container,'.mleAddMorePhotoButtons'));for(var ga=0;ga<da;ga++)this.createPlaceholder(ba[ga]);var ha=ba.slice(0,da);this._updatePhotos(ea,ha);};x.prototype.destroyPlaceholder=function(ba){"use strict";if(!this._loadingIndicators[ba])return;k.remove(this._loadingIndicators[ba].getRoot());delete this._loadingIndicators[ba];};x.prototype.initUploader=function(ba,ca){"use strict";var da=ba.getInput();da.multiple=g.isSupported();ba.subscribe('change',this._uploadPhotos.bind(this,da,ca));};x.prototype._setSaveButtonEnabled=function(ba){"use strict";r.setEnabled(this._saveButton,ba);};x.prototype._uploadPhotos=function(ba,ca){"use strict";j.hide(k.find(this._container,'.mlePhotoButtons'));j.show(k.find(this._container,'.mleAddMorePhotoButtons'));var da=this._getNumPhotos(),ea=ba.files?ba.files.length:1,fa=da+ea;if(fa>this._photoLimit){var ga=q._("The maximum number of photos you can add to this life event is {limit}. Please remove some photos and try again.",{limit:this._photoLimit});i.loadModules(["Dialog"],function(la){new la().setTitle("Too Many Photos").setBody(ga).setButtons(la.OK).show();});y(ba);return;}var ha,ia;for(var ja=0;ja<ea;ja++){ia=ba.files?ba.files[ja].name:ba.value.split('\\').pop();ha=this.createPlaceholder(ia);}this._updatePhotos(fa,[]);ca.uploadData.total_photos=fa;if(this._photoDisplayType!=v)this._pendingPhotoRequests+=ea;var ka=new l(ba).setURI(ca.uploadURI).setData(ca.uploadData).setAllowCrossOrigin(true).setUploadInParallel(true);ka.subscribe('progress',this._onProgress.bind(this));ka.subscribe('success',this._onSuccess.bind(this));ka.subscribe('failure',this._onFailure.bind(this,ia));ka.send();this._setSaveButtonEnabled(false);y(ba);};x.prototype._onProgress=function(ba,ca){"use strict";var event=ca.event,da=this._loadingIndicators[ca.upload.getFile().name];j.hide(k.find(da.getRoot(),'.mlePhotoLoadingIndicator'));j.show(k.find(da.getRoot(),'.mlePhotoProgressBar'));if(event.loaded==event.total){da.setPosition(50);da.setTarget(100,2000);}else da.setPosition(50*event.loaded/event.total);};x.prototype._onSuccess=function(ba,ca){"use strict";this._setSaveButtonEnabled(true);};x.prototype._onFailure=function(ba){"use strict";this.destroyPlaceholder(ba);this._setSaveButtonEnabled(true);};function y(ba){ba.value='';ba.files=null;}function z(ba){j.addClass(ba,'dragging');}function aa(ba,ca){j.removeClass(ca,'dragging');}e.exports=x;});
__d("TimelineMLEPhotoPreview",["Event","CSS","Dialog","DOM","Layer","Parent","TimelineLifeEventPhotoPreviewGrid","$"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=[],p={initPreviewGrid:function(q,r,s){var t=l.byClass(q,'mleContainer');p.destroyPreviewGrid(t);o[t.id]=new m(t,q,r,s);g.listen(j.find(t,'.mleAddMorePhotoButtons'),'click',function(event){o[t.id].filterPhotoClick(event);});},destroyPreviewGrid:function(q){if(o[q.id]){o[q.id].destroy();delete o[q.id];}},initUploader:function(q,r,s){if(o[r])o[r].initUploader(q,s);},attachPhoto:function(q,r,s){if(o[q])o[q].attachPhoto(r,s);},listenForDetach:function(q,r){var s=o[r];g.listen(j.find(q,'.detachPhotoIcon'),'click',s.detachPhoto.bind(s,q));},listenForPhotoSelect:function(q,r){var s=n(r.display_elem),t=false;g.listen(q,'click',function(){if(t)return;t=true;h.hide(j.find(s,'.mlePhotoButtons'));h.show(j.find(s,'.mleAddMorePhotoButtons'));i.getCurrent().hide();var u=o[s.id];if(u)u.addPhotos([r.photo_fbid]);});},listenForSubmit:function(q,r,s){var t=n(s);q.subscribe('confirm',function(){var u=j.scry(q.getContentRoot(),'input[name="'+r+'"]'),v=[];for(var w=0;w<u.length;w++){var x=u[w];if(x.checked===true)v.push(x.value);}h.hide(j.find(t,'.mlePhotoButtons'));h.show(j.find(t,'.mleAddMorePhotoButtons'));var y;if(y=i.getCurrent())y.hide();if(y=k.getTopmostLayer())y.hide();if(o[t.id])o[t.id].addPhotos(v);});}};e.exports=p;});
__d("TimelineMLE",["Arbiter","AsyncRequest","Bootloader","ComposerXController","CSS","DOM","DOMScroll","Event","Form","Parent","ProgressiveDatepicker","RelationshipStatusConst","TimelineCapsule","TimelineComposerUtilities","TimelineContentLoader","TimelineMLEPhotoPreview","$","areJSONRepresentationsEqual","csx","fbt","ge","tidyEvent"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba){var ca=0,da={},ea=null,fa=null;function ga(ra){return p.byClass(ra,'mleFlyoutForm');}function ha(ra){var sa=p.byClass(ra.getContext(),'fbTimelineCapsule');if(sa)return sa;return u.capsuleForCurrentSection();}function ia(ra){var sa=o.serialize(ra);ka(ra,sa);ja(ra,sa);if(!x(sa,da.state)){la(ra);new h().setData(sa).setURI('/ajax/timeline/mle_header.php').setRelativeTo(ra).send();}}function ja(ra,sa){var ta=l.scry(ra,"._594n")[0];if(!ta)return;var ua=sa.hasOwnProperty('name')?sa.name:sa.text_with&&sa.text_with[0];if(ua)l.setContent(ta,z._("{name} will be added to the Family section on your profile.",[z.param("name",ua)]));k.conditionClass(ta,'hidden_elem',!ua);}function ka(ra,sa){var ta=parseInt(sa.type,10),ua=sa['with'],va=l.scry(ra,'input.updateRelationshipStatus')[0];if(!va)return;var wa=l.scry(ra,'li.relationshipConfirmation')[0];if(!wa)return;var xa=l.find(ra,'li.relationshipTooManyPartners');if(ua&&ua.length>1){k.hide(wa);k.show(xa);va.checked=false;va.disabled=true;return;}k.hide(xa);va.disabled=false;var ya=ua&&ua[0],za=l.find(ra,'input.relationshipCurrentPartnerID').value,ab=l.find(ra,'input.relationshipCurrentStatus').value,bb=r.isUnilateralStatus(ta),cb=va.checked&&!bb&&ya&&(za!=ya||ab!=ta);if(ya){var db=sa.text_with[0],eb=l.find(ra,'span.relationshipPartnerName');l.setContent(eb,db);}k.conditionClass(wa,'hidden_elem',!cb);}function la(ra){ra=ra||da.element;if(!ra)return;da={element:ra,state:o.serialize(ra)};}function ma(event){var ra=event.getTarget(),sa=ra.options[ra.selectedIndex];g.inform('TimelineMLE/mleSelectUpdated',ra);var ta=p.byClass(sa,'mleFormContainer');ia(ta);var ua=l.scry(ta,'.mleOtherLabel'),va=l.scry(ta,'.mleOtherField');if(ua.length)ua=ua[0];if(va.length)va=va[0];if(k.hasClass(sa,'mleOther')){k.show(ua);k.show(va);var wa=l.find(va,'.inputOuter').firstChild;wa.focus();}else{k.hide(ua);k.hide(va);}}function na(){if(!ea)return;var ra=ea,sa=l.scry(ra.getInnerContent(),'.mleContainer')[0];sa&&v.destroyPreviewGrid(sa);ra.hide();da={};ea=null;g.inform('TimelineMLE/mleFlyoutHidden');}function oa(ra,sa){l.replace(w(ra),sa);}function pa(ra){if(ra)n.listen(ra,'change',ma);}var qa={cancel:function(ra){if(ga(ra)){qa.hideFlyout();}else{var sa=p.byClass(ra,'mleContainer');sa&&v.destroyPreviewGrid(sa);var ta=p.byClass(ra,'fbTimelineNewMLE'),ua=p.byClass(ra,'fbTimelineCapsule');if(ta){l.remove(ta);}else{ta=p.byClass(ra,'fbTimelineEditMLE');k.removeClass(ta,'fbTimelineEditMLE');l.remove(l.scry(ta,'.timelineUnitContainer')[0]);k.show(l.scry(ta,'.timelineUnitContainer')[0]);}if(k.hasClass(ta,'fbTimelineNotStarred')){k.removeClass(ta,'fbTimelineNotStarred');i.loadModules(["TimelineStar"],function(va){va.unstarUnit(ta.childNodes[0],null,true);});}ua&&s.balanceCapsule(ua);g.inform('TimelineMap/resizeCallout');}da={};return false;},registerButtons:function(ra,sa,ta,ua){ba(n.listen(sa,'mousedown',function(){ra.standalone?ea.setStackable(false):l.setContent(l.find(ua,'.mleInlineErrorMsg'),'');}));if(ta)ba(n.listen(ta,'click',function(va){va.prevent();if(ra.location==='map')g.inform('TimelineMap/cancelCreation');ra.standalone?qa.hideFlyout():qa.cancel(ta);}));},replace:function(ra,sa){var ta=p.byClass(ra,'mleContainer');ta&&v.destroyPreviewGrid(ta);if(ga(ra)){var ua=p.byClass(ra,'fbTimelineEditMLEFlyout');if(ua){ra=p.byClass(w(sa.relativeElementID),'fbTimelineEditMLE');qa.hideFlyout();l.replace(ra,sa.streamStory);ra=w(sa.streamStory);}else{var va=function(ya){var za=aa(sa.relativeElementID);za&&j.reset(za);ya.publish(sa,sa.streamStory);qa.hideFlyout();};if(sa.isFinch){i.loadModules(["PagesStoryPublisher"],va);}else i.loadModules(["TimelineStoryPublisher"],va);ra=w(sa.streamStory);}}var wa=l.scry(ra,'div.keepStarred')[0];if(wa)i.loadModules(["TimelineStar"],function(ya){ya.starUnit(wa,null,true);});var xa=p.byClass(ra,'fbTimelineCapsule');xa&&s.balanceCapsule(xa);return false;},startEdit:function(ra,sa){qa.hideFlyout();var ta=l.scry(ra,'div.timelineUnitContainer')[0];k.hide(ta);k.addClass(ra,'fbTimelineEditMLE');if(!sa)k.addClass(ra,'fbTimelineNotStarred');},showFlyout:function(ra,sa,ta){qa.hideFlyout();ea=ra;ca=0;g.subscribe('TimelineMLE/mleSelectUpdated',function(ya,za){var ab=p.byClass(za,'mleFormOuterContainer'),bb=l.scry(ab,'.registrationLink');if(!bb.length)return;var cb=za.selectedIndex;k.hide(bb[ca]);k.show(bb[cb]);ca=cb;});ra.show();if(sa==='edit'){var ua=w(ta),va=p.byClass(ua,'lifeEventContainer');k.addClass(va,'fbTimelineEditMLE');var wa=l.find(ra.getInnerContent(),'.timelineUnitContainer');k.addClass(wa,'fbTimelineEditMLEFlyout');m.ensureVisible(wa,null,100);}if(sa!='map'){var xa=l.scry(ra.getInnerContent(),'.mleSelect');if(xa.length)pa(xa[0]);}if(sa!=='edit')qa.setEstimatedDate(ra);g.inform('TimelineMLE/mleFlyoutShown',ra);},showPrivacyNotice:function(ra,sa){if(!sa||!ra)return;var ta=l.find(ra.getInnerContent(),'.audienceSelector');sa.setContext(ta).show();fa=sa;n.listen(ta,'click',sa.hide.bind(sa));n.listen(l.find(sa.getContent(),'input'),'click',sa.hide.bind(sa));g.subscribe('TimelineMLE/mleFlyoutHidden',sa.hide.bind(sa));},hideFlyout:na,getFlyout:function(){return ea;},listenForEditChanges:function(ra){var sa=l.find(ra,'form.mleFormContainer'),ta=sa.elements;for(var ua=0;ua<ta.length;++ua){if(p.byClass(ta[ua],'uiTypeahead')||p.byClass(ta[ua],'uiTokenizer')||k.hasClass(ta[ua],'mleSelect'))continue;if(k.hasClass(ta[ua],'inputradio')){n.listen(ta[ua],'click',ia.bind(null,sa));}else if(p.byClass(ta[ua],'mleDatepicker')){n.listen(ta[ua],'change',ia.bind(null,sa));}else n.listen(ta[ua],'blur',ia.bind(null,sa));}da={element:sa,state:o.serialize(sa)};var va=l.scry(ra,'input.updateRelationshipStatus')[0];if(va)ba(n.listen(va,'change',function(){var wa=o.serialize(sa);ka(sa,wa);}));},updateHeader:function(ra){ia(p.byClass(ra,'mleFormContainer'));},setEstimatedDate:function(ra){var sa=l.scry(ra.getContentRoot(),'.fbTimelineComposerUnit')[0];if(!sa){var ta=q.getInstance(l.scry(ra.getInnerContent(),'.uiProgressiveDatepicker')[0]);if(ta)t.setEstimatedDate(ta,ha(ra));}},updatePrivacyNoticePosition:function(){fa&&fa.updatePosition();},registerOptionHandler:function(ra){var sa=l.scry(ra,'.lifeEventContainer')[0],ta=l.scry(sa,'.mleSelect');if(ta.length)pa(ta[0]);},subscribeToTypeahead:function(ra,sa){ra.subscribe(['select','unselect','reset','blur'],qa.updateHeader.bind(null,sa));},subscribeToTokenizer:function(ra,sa){ra.subscribe(['addToken','removeToken'],qa.updateHeader.bind(null,sa));},replaceYearlySummary:function(ra){oa('pagelet_yearly',ra);na();},replaceHometown:function(ra){oa('pagelet_hometown',ra);na();}};e.exports=a.TimelineMLE||qa;});
__d("legacy:TimelineMLE",["TimelineMLE"],function(a,b,c,d){a.TimelineMLE=b('TimelineMLE');},3);
__d("MapAppSectionCuration",["Arbiter","TimelineAppSectionCuration"],function(a,b,c,d,e,f,g,h){var i={registerContent:function(j){h.register(j,function(k,l,m){g.inform('TimelineMapStickyHeaderComposer/showPhotoTagUnit');m.unsubscribe();});}};e.exports=i;});